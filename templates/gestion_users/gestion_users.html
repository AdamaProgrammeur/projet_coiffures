{% extends "layout/base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Gestion des Utilisateurs</h3>
    <button class="btn btn-primary" id="addUserBtn">
        <i class="fa fa-plus"></i> Nouveau
    </button>
</div>

<div id="alert-container"></div>

<!-- Recherche -->
<div class="mb-3">
    <input type="text" id="searchInput" class="form-control"
           placeholder="Rechercher par username, email, prénom ou nom...">
</div>

<table class="table table-hover table-bordered">
    <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Prénom</th>
            <th>Nom</th>
            <th>Email</th>
            <th>Rôle</th>
            
            <th width="180">Actions</th>
        </tr>
    </thead>
    <tbody id="users-table"></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalTitle">Utilisateur</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="user-id">

                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control mb-3" required>

                    <label class="form-label">Prénom</label>
                    <input type="text" id="first_name" class="form-control mb-3" required>

                    <label class="form-label">Nom</label>
                    <input type="text" id="last_name" class="form-control mb-3" required>

                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-control mb-3" required>

                    <label class="form-label">Mot de passe</label>
                    <input type="password" id="password" class="form-control mb-3"
                           placeholder="Laisser vide si inchangé">
                    <label class="form-label">Rôle</label>
                    <select id="role" class="form-select mb-3" required>
                        <option value="ADMIN">Admin</option>
                        <option value="COIFFEUR">Coiffeur</option>
                        <option value="RECEPTIONNISTE">Réceptionniste</option>
                    </select>

                    <button type="submit" class="btn btn-success w-100">
                        Enregistrer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    const table = document.getElementById("users-table");
    const searchInput = document.getElementById("searchInput");
    const modalElement = document.getElementById("userModal");
    const modal = new bootstrap.Modal(modalElement);

    let allUsers = [];

    // =========================
    // Fonction pour afficher une alerte
    // =========================
    function showAlert(msg, type="success") {
        document.getElementById("alert-container").innerHTML =
            `<div class="alert alert-${type} alert-dismissible fade show">
                ${msg}
                <button class="btn-close" data-bs-dismiss="alert"></button>
             </div>`;
    }

    // =========================
    // Récupération des utilisateurs depuis l'API
    // =========================
    async function fetchUsers() {
        try {
            const res = await fetch("/accounts/api/users/", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Erreur chargement utilisateurs");
            allUsers = await res.json();
            return allUsers;
        } catch (err) {
            showAlert(err.message, "danger");
            return [];
        }
    }

    async function loadUsers() {
        const users = await fetchUsers();
        renderTable(users);
    }

    // =========================
    // Affichage de la table
    // =========================
    function renderTable(users) {
        table.innerHTML = "";
        users.forEach(u => {
            table.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.first_name}</td>
                    <td>${u.last_name}</td>
                    <td>${u.email}</td>
                    <td><span class="badge bg-info">${u.role}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${u.id}">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${u.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        attachEvents();
    }

    // =========================
    // Gestion des boutons Edit/Delete
    // =========================
    function attachEvents() {
        document.querySelectorAll(".edit-btn").forEach(btn => {
            btn.onclick = () => editUser(btn.dataset.id);
        });
        document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.onclick = () => deleteUser(btn.dataset.id);
        });
    }

    function editUser(id) {
        const user = allUsers.find(u => u.id == id);
        if (!user) return;

        document.getElementById("modalTitle").innerText = "Modifier utilisateur";
        document.getElementById("user-id").value = user.id;
        document.getElementById("username").value = user.username;
        document.getElementById("first_name").value = user.first_name;
        document.getElementById("last_name").value = user.last_name;
        document.getElementById("email").value = user.email;
        document.getElementById("role").value = user.role;
        document.getElementById("photo").value = user.photo;
        document.getElementById("password").value = ""; // Mot de passe vide
        modal.show();
    }

    async function deleteUser(id) {
        if (!confirm("Confirmer suppression ?")) return;
        try {
            const res = await fetch(`/accounts/api/users/${id}/`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Erreur suppression");
            showAlert("Utilisateur supprimé");
            await loadUsers();
        } catch (err) {
            showAlert(err.message, "danger");
        }
    }

    // =========================
    // Ouvrir le modal pour création
    // =========================
    document.getElementById("addUserBtn").onclick = () => {
        document.getElementById("modalTitle").innerText = "Nouvel utilisateur";
        document.getElementById("user-form").reset();
        document.getElementById("user-id").value = "";
        modal.show();
    };

    // =========================
    // Submit form (create/update)
    // =========================
    document.getElementById("user-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const id = document.getElementById("user-id").value;

        const payload = {
            username: document.getElementById("username").value,
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            email: document.getElementById("email").value,
            
            role: document.getElementById("role").value
        };

        const passwordVal = document.getElementById("password").value;

        // Mot de passe obligatoire seulement pour création
        if (!id && !passwordVal) {
            return showAlert("Le mot de passe est obligatoire pour créer un utilisateur", "danger");
        }

        if (passwordVal) payload.password = passwordVal;

        const url = id ? `/accounts/api/users/${id}/` : "/accounts/api/users/";
        const method = "POST" ;

        try {
            const res = await fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                showAlert("Utilisateur enregistré");
                bootstrap.Modal.getInstance(document.getElementById("userModal")).hide();
                await loadUsers();
            } else {
                showAlert("Erreur : " + JSON.stringify(data), "danger");
            }
        } catch (err) {
            showAlert("Erreur : " + err.message, "danger");
        }
    });

    // =========================
    // Recherche dynamique
    // =========================
    searchInput.addEventListener("keyup", function () {
        const keyword = this.value.toLowerCase();
        const filtered = allUsers.filter(u =>
            u.username.toLowerCase().includes(keyword) ||
            u.email.toLowerCase().includes(keyword) ||
            u.first_name.toLowerCase().includes(keyword) ||
            u.last_name.toLowerCase().includes(keyword)
        );
        renderTable(filtered);
    });

    // =========================
    // Chargement initial
    // =========================
    loadUsers();
});
</script>
{% endblock %}