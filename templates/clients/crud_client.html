{% extends "layout/base.html" %}

{% block content %}
<h2>CRUD Clients</h2>

<!-- Recherche dynamique -->
<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un client...">
    </div>
</div>

<!-- Bouton Ajouter -->
<button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addClientModal">
    <i class="fa fa-plus"></i> Ajouter
</button>
<button class="btn btn-primary mb-2">
    <i class="fa fa-plus"></i> <a href="{% url 'crud_file_page' %}" style="color: white; text-decoration: none;">Ajouter a la file
</a></button>



<!-- Tableau des clients -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>T√©l√©phone</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="clientsTableBody"></tbody>
</table>

<!-- Modal Ajouter Client -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addClientForm">
                <div class="modal-header">
                    <h5>Ajouter Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="addNom" placeholder="Nom" required>
                    <input type="text" class="form-control mb-2" id="addPrenom" placeholder="Pr√©nom" required>
                    <input type="text" class="form-control mb-2" id="addTelephone" placeholder="T√©l√©phone" required>
                    <div id="addError" class="text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifier Client -->
<div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editClientForm">
                <div class="modal-header">
                    <h5>Modifier Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="editNom" placeholder="Nom" required>
                    <input type="text" class="form-control mb-2" id="editPrenom" placeholder="Pr√©nom" required>
                    <input type="text" class="form-control mb-2" id="editTelephone" placeholder="T√©l√©phone" required>
                    <div id="editError" class="text-danger"></div>
                    <input type="hidden" id="editClientId">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Modifier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Supprimer Client -->
<div class="modal fade" id="deleteClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Supprimer Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer ce client ?</p>
                <input type="hidden" id="deleteClientId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    if (!token) { window.location.href = "/accounts/login/"; return; }

    let clientsList = [];

    // üîπ Charger clients
    function loadClients() {
        fetch("/api/clients/", { headers: { "Authorization": "Bearer " + token } })
        .then(res => res.json())
        .then(data => {
            clientsList = data;
            renderClients(data);
        })
        .catch(err => console.error(err));
    }

    // üîπ Affichage clients
    function renderClients(data) {
        const tbody = document.getElementById("clientsTableBody");
        tbody.innerHTML = "";
        data.forEach(c => {
            tbody.innerHTML += `
                <tr>
                    <td>${c.nom}</td>
                    <td>${c.prenom}</td>
                    <td>${c.telephone}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal(${c.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${c.id})">üóë</button>
                    </td>
                </tr>
            `;
        });
    }

    // üîπ Validation t√©l√©phone
    function formatTelephone(value) {
        let numero = value.replace(/[\s\-]/g, '');
        if (!numero.startsWith("+223")) numero = "+223" + numero;
        return numero;
    }

    // üîπ V√©rification champs nom/prenom
    function validateNomPrenom(nom, prenom) {
        if (!nom.trim() || !prenom.trim()) {
            return "Nom et Pr√©nom ne peuvent pas √™tre vides.";
        }
        return null;
    }

    // üîπ Ajouter client
    const addModal = new bootstrap.Modal(document.getElementById("addClientModal"));
    document.getElementById("addClientForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const nom = document.getElementById("addNom").value;
        const prenom = document.getElementById("addPrenom").value;
        let telephone = formatTelephone(document.getElementById("addTelephone").value);

        const errMsg = validateNomPrenom(nom, prenom);
        if (errMsg) {
            document.getElementById("addError").innerText = errMsg;
            return;
        } else {
            document.getElementById("addError").innerText = "";
        }

        fetch("/api/clients/", {
            method: "POST",
            headers: { 
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ nom, prenom, telephone })
        })
        .then(res => {
            if (!res.ok) return res.json().then(err => { throw err; });
            return res.json();
        })
        .then(() => {
            loadClients();
            this.reset();
            addModal.hide();
        })
        .catch(err => {
            document.getElementById("addError").innerText = JSON.stringify(err);
        });
    });

    // üîπ Ouvrir modal modifier
    window.openEditModal = function(id) {
        const client = clientsList.find(c => c.id === id);
        if (!client) return;
        document.getElementById("editNom").value = client.nom;
        document.getElementById("editPrenom").value = client.prenom;
        document.getElementById("editTelephone").value = client.telephone;
        document.getElementById("editClientId").value = client.id;
        new bootstrap.Modal(document.getElementById("editClientModal")).show();
    }

    // üîπ Modifier client
    const editModal = new bootstrap.Modal(document.getElementById("editClientModal"));
    document.getElementById("editClientForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const id = document.getElementById("editClientId").value;
        const nom = document.getElementById("editNom").value;
        const prenom = document.getElementById("editPrenom").value;
        const telephone = formatTelephone(document.getElementById("editTelephone").value);

        const errMsg = validateNomPrenom(nom, prenom);
        if (errMsg) {
            document.getElementById("editError").innerText = errMsg;
            return;
        } else {
            document.getElementById("editError").innerText = "";
        }

        fetch(`/api/clients/${id}/`, {
            method: "PUT",
            headers: { 
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ nom, prenom, telephone })
        })
        .then(res => {
            if (!res.ok) return res.json().then(err => { throw err; });
            return res.json();
        })
        .then(() => {
            loadClients();
            editModal.hide();
        })
        .catch(err => {
            document.getElementById("editError").innerText = JSON.stringify(err);
        });
    });

    // üîπ Ouvrir modal supprimer
    window.openDeleteModal = function(id) {
        document.getElementById("deleteClientId").value = id;
        new bootstrap.Modal(document.getElementById("deleteClientModal")).show();
    }

    // üîπ Confirmer suppression
    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        const id = document.getElementById("deleteClientId").value;
        fetch(`/api/clients/${id}/`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } })
        .then(res => {
            if (!res.ok) throw new Error("Erreur suppression");
            loadClients();
            bootstrap.Modal.getInstance(document.getElementById("deleteClientModal")).hide();
        })
        .catch(err => console.error(err));
    });

    // üîπ Recherche dynamique
    document.getElementById("searchInput").addEventListener("input", function() {
        const value = this.value.toLowerCase();
        const filtered = clientsList.filter(c => 
            c.nom.toLowerCase().includes(value) ||
            c.prenom.toLowerCase().includes(value) ||
            c.telephone.includes(value)
        );
        renderClients(filtered);
    });

    // Charger au d√©marrage
    loadClients();
});
</script>
{% endblock %}