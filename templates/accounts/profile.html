{% extends "layout/base.html" %}

{% block content %}
<h2>Profile</h2>
<form id="profileForm">
  <div class="mb-3">
      <label>Email</label>
      <input type="email" class="form-control" id="profileEmail" value="">
  </div>
  <div class="mb-3">
      <label>Nom complet</label>
      <input type="text" class="form-control" id="profileNom" value="">
  </div>
  <button type="submit" class="btn btn-primary">Enregistrer</button>
</form>

<script>
async function loadProfile() {
    try {
        const token = localStorage.getItem("access_token");

        if (!token) {
            // Si pas de token, redirection vers login
            window.location.href = "/accounts/login/";
            return;
        }

        // Récupération du profil via API
        const res = await fetch("{% url 'accounts:profile_api' %}", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            }
        });

        if (res.status === 401) {
            // Token invalide ou expiré
            localStorage.removeItem("access_token");
            window.location.href = "";
            return;
        }

        if (!res.ok) throw new Error("Impossible de charger le profil");

        const data = await res.json();

        document.getElementById("profileEmail").value = data.email || "";
        document.getElementById("profileNom").value = data.nom_complet || "";

    } catch (err) {
        alert(err.message);
    }
}

// Soumission du formulaire pour mettre à jour le profil
document.getElementById("profileForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("access_token");

    const payload = {
        email: document.getElementById("profileEmail").value,
        nom_complet: document.getElementById("profileNom").value
    };

    try {
        const res = await fetch("/accounts/api/profile/", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Impossible de mettre à jour le profil");

        alert("Profil mis à jour avec succès !");
        loadProfile(); // recharge les infos

    } catch (err) {
        alert(err.message);
    }
});

// Charger le profil dès le chargement de la page
window.addEventListener("DOMContentLoaded", loadProfile);
</script>
{% endblock %}
