{% extends "layout/base.html" %}

{% block content %}
<div class="container mt-4">

    <h3 class="mb-4">ðŸ’³ Gestion des Paiements</h3>

    <!-- Alert Bootstrap -->
    <div id="alert-container"></div>

    <div class="row">

        <!-- ================= CLIENT INFO ================= -->
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    Informations Client
                </div>
                <div class="card-body">
                    <p><strong>Client :</strong> <span id="client-nom">â€”</span></p>
                    <p><strong>Service :</strong> <span id="client-service">â€”</span></p>
                    <p><strong>Montant total :</strong> <span id="client-prix">â€”</span></p>
                    <p><strong>Montant payÃ© :</strong> <span id="client-montant-paye">â€”</span></p>
                    <p><strong>Reste Ã  payer :</strong> <span id="client-reste">â€”</span></p>
                    <p><strong>Statut :</strong> <span id="client-statut">â€”</span></p>
                    <p><strong>Heure dÃ©but :</strong> <span id="client-debut">â€”</span></p>
                </div>
            </div>
        </div>

        <!-- ================= FORMULAIRE ================= -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    Nouveau Paiement
                </div>
                <div class="card-body">

                    <form id="paiement-form">

                        <!-- Client -->
                        <div class="mb-3">
                            <label class="form-label">Client en cours</label>
                            <select id="client-select" class="form-select" required>
                                <option value="">-- SÃ©lectionner un client --</option>
                            </select>
                        </div>

                        <!-- Montant -->
                        <div class="mb-3">
                            <label class="form-label">Montant</label>
                            <input type="number" class="form-control" id="montant" min="0" required>
                        </div>

                        <!-- Mode -->
                        <div class="mb-3">
                            <label class="form-label">Mode de paiement</label>
                            <select id="mode" class="form-select" required>
                                <option value="ESPECES">EspÃ¨ces</option>
                                <option value="CARTE">Carte</option>
                                <option value="MOBILE">Mobile Money</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-success w-100" id="paiement-btn">
                            ðŸ’³ Valider le paiement
                        </button>

                    </form>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    const btnPaiement = document.getElementById("paiement-btn");

    function showAlert(message, type="danger") {
        const container = document.getElementById("alert-container");
        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
    }

    let clientsData = []; // stocke les clients EN_COURS

    // ------------------ Charger clients EN_COURS ------------------
    async function loadClients() {
        try {
            const res = await fetch("/api/paiements/clients_en_cours/", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Impossible de charger les clients.");

            const data = await res.json();
            clientsData = data;

            const select = document.getElementById("client-select");
            select.innerHTML = '<option value="">-- SÃ©lectionner un client --</option>';

            data.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c.id;
                opt.textContent = `${c.client_nom} (${c.service_nom})`;
                select.appendChild(opt);
            });

        } catch (err) {
            showAlert(err.message);
        }
    }
    loadClients();

    // ------------------ Afficher infos client sÃ©lectionnÃ© ------------------
    document.getElementById("client-select").addEventListener("change", function () {
        const id = this.value;
        if (!id) {
            resetClientInfo();
            return;
        }

        const client = clientsData.find(c => c.id == id);
        if (!client) {
            resetClientInfo();
            showAlert("Client introuvable !");
            return;
        }

        document.getElementById("client-nom").textContent = client.client_nom;
        document.getElementById("client-service").textContent = client.service_nom;
        document.getElementById("client-prix").textContent = client.prix_service;
        document.getElementById("client-montant-paye").textContent = client.montant_paye;
        document.getElementById("client-reste").textContent = client.reste;
        document.getElementById("client-statut").textContent = client.statut;
        document.getElementById("client-debut").textContent = client.date_debut;

        // DÃ©sactiver si dÃ©jÃ  payÃ©
        btnPaiement.disabled = (client.reste <= 0);
    });

    function resetClientInfo() {
        document.getElementById("client-nom").textContent = "â€”";
        document.getElementById("client-service").textContent = "â€”";
        document.getElementById("client-prix").textContent = "â€”";
        document.getElementById("client-montant-paye").textContent = "â€”";
        document.getElementById("client-reste").textContent = "â€”";
        document.getElementById("client-statut").textContent = "â€”";
        document.getElementById("client-debut").textContent = "â€”";
        btnPaiement.disabled = false;
    }

    // ------------------ Soumission Paiement ------------------
    document.getElementById("paiement-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const clientId = document.getElementById("client-select").value;
        const montant = parseFloat(document.getElementById("montant").value);
        const mode = document.getElementById("mode").value;

        if (!clientId) { showAlert("SÃ©lectionnez un client !"); return; }
        if (montant <= 0) { showAlert("Montant invalide !"); return; }

        try {
            const res = await fetch("/api/paiements/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    file_attente: clientId,
                    montant: montant,
                    mode_paiement: mode
                })
            });

            const data = await res.json();

            if (!res.ok) {
                showAlert(data.error || "Erreur lors du paiement.");
                return;
            }

            showAlert(
                `Paiement enregistrÃ©. Montant payÃ© : ${data.montant_paye}, reste : ${data.reste}`,
                "success"
            );

            // Mettre Ã  jour la section info client
            const client = clientsData.find(c => c.id == clientId);
            if (client) {
                client.montant_paye = data.montant_paye;
                client.reste = data.reste;
            }

            document.getElementById("client-montant-paye").textContent = data.montant_paye;
            document.getElementById("client-reste").textContent = data.reste;

            // DÃ©sactiver si payÃ© entiÃ¨rement
            if (data.reste <= 0) btnPaiement.disabled = true;

            document.getElementById("paiement-form").reset();

            // rafraÃ®chir liste clients EN_COURS
            loadClients();

        } catch (err) {
            showAlert("Erreur rÃ©seau ou serveur.");
            console.error(err);
        }
    });

});
</script>
{% endblock %}