{% extends "layout/base.html" %}

{% block content %}
<h2>CRUD Services</h2>

<!-- Recherche dynamique -->
<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un service...">
    </div>
</div>

<!-- Bouton Ajouter -->
<button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#addServiceModal">
    <i class="fa fa-plus"></i> Ajouter
</button>

<!-- Tableau des services -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Prix</th>
            <th>Image</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="servicesTableBody"></tbody>
</table>

<!-- Modal Ajouter Service -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addServiceForm">
                <div class="modal-header">
                    <h5>Ajouter Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="addNom" placeholder="Nom" >
                    <input type="number" class="form-control mb-2" id="addPrix" placeholder="Prix">
                    <input type="file" class="form-control mb-2" id="addImage">
                    <div id="addError" class="text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifier Service -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editServiceForm">
                <div class="modal-header">
                    <h5>Modifier Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-2" id="editNom" placeholder="Nom" required>
                    <input type="number" class="form-control mb-2" id="editPrix" placeholder="Prix" required>
                    <input type="file" class="form-control mb-2" id="editImage">
                    <div id="editError" class="text-danger"></div>
                    <input type="hidden" id="editServiceId">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-warning">Modifier</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Supprimer Service -->
<div class="modal fade" id="deleteServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Supprimer Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer ce service ?</p>
                <input type="hidden" id="deleteServiceId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = localStorage.getItem("access_token");
    if (!token) { window.location.href = "/accounts/login/"; return; }

    let servicesList = [];

    function loadServices() {
        fetch("/api/services/", { headers: { "Authorization": "Bearer " + token } })
        .then(res => res.json())
        .then(data => {
            servicesList = data;
            renderServices(data);
        })
        .catch(err => console.error(err));
    }

    function renderServices(data) {
        const tbody = document.getElementById("servicesTableBody");
        tbody.innerHTML = "";
        data.forEach(s => {
            tbody.innerHTML += `
                <tr>
                    <td>${s.nom}</td>
                    <td>${s.prix}</td>
                    <td>${s.image ? `<img src="${s.image}" width="50">` : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal(${s.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="openDeleteModal(${s.id})">üóë</button>
                    </td>
                </tr>
            `;
        });
    }

    // üîπ Validation nom et prix
    function validateService(nom, prix) {
        if (!nom.trim()) return "Le nom ne peut pas √™tre vide.";
        if (!prix || Number(prix) <= 0) return "Le prix doit √™tre sup√©rieur √† 0.";
        return null;
    }

    // üîπ Ajouter service
    const addModal = new bootstrap.Modal(document.getElementById("addServiceModal"));
    document.getElementById("addServiceForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const nom = document.getElementById("addNom").value;
        const prix = document.getElementById("addPrix").value;
        const file = document.getElementById("addImage").files[0];

        const errMsg = validateService(nom, prix);
        if (errMsg) {
            document.getElementById("addError").innerText = errMsg;
            return;
        } else {
            document.getElementById("addError").innerText = "";
        }

        const formData = new FormData();
        formData.append("nom", nom);
        formData.append("prix", prix);
        if (file) formData.append("image", file);

        fetch("/api/services/", { method: "POST", headers: { "Authorization": "Bearer " + token }, body: formData })
        .then(res => res.json())
        .then(() => {
            loadServices();
            this.reset();
            addModal.hide();
        })
        .catch(err => console.error(err));
    });

    // üîπ Ouvrir modal modifier
    window.openEditModal = function(id) {
        const service = servicesList.find(s => s.id === id);
        if (!service) return;
        document.getElementById("editNom").value = service.nom;
        document.getElementById("editPrix").value = service.prix;
        document.getElementById("editServiceId").value = service.id;
        new bootstrap.Modal(document.getElementById("editServiceModal")).show();
    }

    // üîπ Modifier service
    const editModal = new bootstrap.Modal(document.getElementById("editServiceModal"));
    document.getElementById("editServiceForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const id = document.getElementById("editServiceId").value;
        const nom = document.getElementById("editNom").value;
        const prix = document.getElementById("editPrix").value;
        const file = document.getElementById("editImage").files[0];

        const errMsg = validateService(nom, prix);
        if (errMsg) {
            document.getElementById("editError").innerText = errMsg;
            return;
        } else {
            document.getElementById("editError").innerText = "";
        }

        const formData = new FormData();
        formData.append("nom", nom);
        formData.append("prix", prix);
        if (file) formData.append("image", file);

        fetch(`/api/services/${id}/`, { method: "PUT", headers: { "Authorization": "Bearer " + token }, body: formData })
        .then(res => res.json())
        .then(() => {
            loadServices();
            editModal.hide();
        })
        .catch(err => console.error(err));
    });

    // üîπ Ouvrir modal supprimer
    window.openDeleteModal = function(id) {
        document.getElementById("deleteServiceId").value = id;
        new bootstrap.Modal(document.getElementById("deleteServiceModal")).show();
    }

    // üîπ Confirmer suppression
    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
        const id = document.getElementById("deleteServiceId").value;
        fetch(`/api/services/${id}/`, { method: "DELETE", headers: { "Authorization": "Bearer " + token } })
        .then(() => {
            loadServices();
            bootstrap.Modal.getInstance(document.getElementById("deleteServiceModal")).hide();
        })
        .catch(err => console.error(err));
    });

    // üîπ Recherche dynamique
    document.getElementById("searchInput").addEventListener("input", function() {
        const value = this.value.toLowerCase();
        const filtered = servicesList.filter(s =>
            s.nom.toLowerCase().includes(value) ||
            String(s.prix).includes(value)
        );
        renderServices(filtered);
    });

    // Charger au d√©marrage
    loadServices();
});
</script>
{% endblock %}